<!DOCTYPE html>
<html>
  <head>
    <title>GEoTweet distribution langues </title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    <!-- Utilise LESS -->
    <link rel="stylesheet/less" type="text/css" href="less/styles.less">
    <script src="lib/less.min.js" type="text/javascript"></script>

    <link rel="shortcut icon" href="http://cartodb.com/assets/favicon.ico" />

    <script type="cartocss/text" id="cartocss">
    /** torque visualization */

    // start change here
    Map {
    -torque-frame-count:256;
    -torque-animation-duration:30;
    -torque-time-attribute:"created_at_dt";
    -torque-aggregation-function:"CDB_Math_Mode(lang_id)";
    -torque-resolution:2;
    -torque-data-aggregation:linear;
    }

    @color_ar : #A6CEE3;    // light-blue
    @color_de : #B2DF8A;    // light-green
    @color_en : #E31A1C;    // red
    @color_es : #FDBF6F;    // light-orange
    @color_fr : #1F78B4;    // blue
    @color_ht : #FB9A99;    // light-pink
    @color_it : #6A3D9A;    // violet
    @color_ja : #FF7F00;    // orange
    @color_pt : #33A02C;    // green
    @color_und : #CAB2D6;   // light-violet
    @color_others : #DDDDDD;  // grey

    #table_24d{
      comp-op: source-over;
      marker-fill-opacity: 0.9;
      marker-line-color: #FFF;
      marker-line-width: 0;
      marker-line-opacity: 1;
      marker-type: ellipse;
      marker-width: 6;
      marker-fill: #0F3B82;
    }
    #table_24d[frame-offset=1] {
     marker-width:8;
     marker-fill-opacity:0.45;
    }
    #table_24d[frame-offset=2] {
     marker-width:10;
     marker-fill-opacity:0.225;
    }
    #table_24d[value=1] {
       marker-fill: @color_en;
    }
    #table_24d[value=2] {
       marker-fill: @color_fr;
    }
    #table_24d[value=3] {
       marker-fill: @color_es;
    }
    #table_24d[value=4] {
       marker-fill: @color_pt;
    }
    #table_24d[value=5] {
       marker-fill: @color_ja;
    }
    #table_24d[value=6] {
       marker-fill: @color_ar;
    }
    #table_24d[value=7] {
       marker-fill: @color_de;
    }
    #table_24d[value=8] {
       marker-fill: @color_ht;
    }
    #table_24d[value=9] {
       marker-fill: @color_it;
    }
    #table_24d[value=10] {
       marker-fill: @color_und;
    }
    #table_24d {
       marker-fill: @color_others;
    }
// end change here
    </script>

    <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/3.15/themes/css/cartodb.css" />
  </head>
  <body>
    <div id="map"></div>

    <div id="desc"><h3>24h de Tweets à Genève <span id="location"></span></h3></div>

    <div id="sql-buttons" class="layer_selector">
      <p>Langues</p>
      <ul>

        <li data=" WHERE lang_s = 'fr'" data-type="sql">
          <span data=" WHERE lang_s = 'fr'" class="lang-square-fr"></span> fr
        </li>

        <li data=" WHERE lang_s = 'de'" data-type="sql">
          <span data=" WHERE lang_s = 'de'" class="lang-square-de"> </span> de
        </li>

        <li data=" WHERE lang_s = 'it'" data-type="sql">
          <span data=" WHERE lang_s = 'it'" class="lang-square-it"> </span> it
        </li>


        <li data=" WHERE lang_s = 'en'" data-type="sql">
          <span data=" WHERE lang_s = 'en'"  class="lang-square-en"> </span> en
        </li>


        <li data=" WHERE lang_s = 'pt'" data-type="sql">
          <span data=" WHERE lang_s = 'pt'" class="lang-square-pt"> </span> pt
        </li>

        <li data=" WHERE lang_s = 'es'" data-type="sql">
          <span data=" WHERE lang_s = 'es'" class="lang-square-es"> </span> es
        </li>

        <li data=" WHERE lang_s = 'ar'" data-type="sql">
          <span data=" WHERE lang_s = 'ar'" class="lang-square-ar"> </span> ar
        </li>

        <li data=" WHERE lang_s = 'ja'" data-type="sql">
          <span data=" WHERE lang_s = 'ja'"  class="lang-square-ja"> </span> ja
        </li>

        <li data=" WHERE lang_s = 'ht'" data-type="sql">
          <span data=" WHERE lang_s = 'ht'" class="lang-square-ht"> </span> ht
        </li>

        <li data=" WHERE lang_s = 'und'" data-type="sql">
          <span data=" WHERE lang_s = 'und'"  class="lang-square-und"> </span> un
        </li>

        <li data=" WHERE lang_id = 11" data-type="others">
          <span data=" WHERE lang_id = 11"  class="lang-square-others"> </span> ot
        </li>

        <li data="XXXXX" data-type="sql">
            raz
        </li>
      </ul>
    </div>

    <script src="http://libs.cartocdn.com/cartodb.js/v3/3.15/cartodb.js"></script>

    <script>
      function main() {



          var layer = L.tileLayer('http://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png', {
              attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="http://cartodb.com/attributions">CartoDB</a>'
          });

          // start change here
          var map = new L.map('map', {
              scrollWheelZoom: false,
              center: [46.2,6.15],
              zoom: 14
          });
          // stop change here

          map.addLayer(layer);
          console.log(layer);
          // start change here
          var tableName = "table_24d";
          var userName = "geotweet";

          var layerSource = {
              type: 'torque',
              options: {
                  query: "SELECT * FROM " + tableName,
                  user_name: userName,
                  cartocss: $("#cartocss").html()
              }
          }
          // stop change here


           // Create layer selector
           function createSelector(layer) {
               var condition = "";
               var $options = $(".layer_selector").find("li");
               $options.click(function(e) {
                   layer.stop();
                   var $li = $(e.target);
                   var selected = $li.attr('data');
                   if (selected === 'XXXXX') {
                       var newSQL = "SELECT * FROM " + tableName;
                       $("#location").text("");
                   } else {
                       //var newSQL = Mustache.render($("#sql").html(),{country: selected});
                       var newSQL = "SELECT * FROM " + tableName + selected;
                       $("#location").text("to " + selected);
                   }

                   console.log(newSQL);
                   layer.setSQL(newSQL).on('load', function() {
                       layer.play();
                   });
               });
           }


          cartodb.createLayer(map, layerSource)
            .addTo(map)
            .done(function(layer) {
                var torqueLayer = layer;
                console.log(layer);
                // once animation is loaded, automatically play
                torqueLayer.on('load', function() {
                    torqueLayer.play();
                });

                // pause animation at last frame
                torqueLayer.on('change:time', function(changes) {
                    if (changes.step === torqueLayer.provider.getSteps() - 1) {
                        torqueLayer.pause();
                    }
                });
                createSelector(torqueLayer);
            })
            .error(function(err) {
                console.log("Error: " + err);
            });
      }

      window.onload = main;
    </script>
  </body>
</html>
